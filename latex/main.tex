\documentclass[11pt]{article}
\usepackage[margin=1in]{geometry}
\usepackage{pgfplots}
\usepackage{pgfplotstable}
\usepackage{tikz}
\usepackage{filecontents}
\usepackage{subcaption}

\pgfplotsset{compat=1.17}

% Define styles for each object
\pgfplotsset{
    CuckooStyle/.style={fill=blue!70!gray!15, draw=blue!85!gray!45},
    IcebergStyle/.style={fill=red!75!pink!15, draw=red!90!pink!55},
    JunctionStyle/.style={fill=yellow!65!gray!15, draw=orange!80!black!50},
    TPHTStyle/.style={fill=green!65!black!15, draw=green!80!black!55},
    BlastStyle/.style={fill=violet!60!gray!15, draw=violet!75!gray!50}
}

% Helper function for addplot commands
% #1 = style name, #2 = object_id, #3 = throughput type, #4 = case_id, #5 = entry_id
\newcommand{\addDataPlot}[5]{%
\addplot[#1] table[y expr=\thisrow{#3 (ops/s)}/1000000, restrict expr to domain={\thisrow{entry_id}}{#5:#5}, restrict expr to domain={\thisrow{case_id}}{#4:#4}, restrict expr to domain={\thisrow{object_id}}{#2:#2}]{\data};%
}

% Function to add all 5 plots for standard objects (6,7,15,17,20)
% #1 = case_id, #2 = throughput type, #3 = entry_id
\newcommand{\addAllStandardPlots}[3]{%
\addDataPlot{CuckooStyle}{6}{#2}{#1}{#3}
\addDataPlot{IcebergStyle}{7}{#2}{#1}{#3}
\addDataPlot{JunctionStyle}{15}{#2}{#1}{#3}
\addDataPlot{TPHTStyle}{17}{#2}{#1}{#3}
\addDataPlot{BlastStyle}{20}{#2}{#1}{#3}
}

% Function to add all 5 plots for resizing objects (6,7,15,18,21)
% #1 = case_id, #2 = throughput type, #3 = entry_id
\newcommand{\addAllResizingPlots}[3]{%
\addDataPlot{CuckooStyle}{6}{#2}{#1}{#3}
\addDataPlot{IcebergStyle}{7}{#2}{#1}{#3}
\addDataPlot{JunctionStyle}{15}{#2}{#1}{#3}
\addDataPlot{TPHTStyle}{18}{#2}{#1}{#3}
\addDataPlot{BlastStyle}{21}{#2}{#1}{#3}
}

% Define the 2D dictionary for case_id and entry_id mappings
% When entry_id=0, all case_ids map to "Load"
% When entry_id=1: 17→Run A, 18→Run B, 19→Run C, 20→Run A^-, 21→Run B^-, 22→Run C^-
\def\getlabelname#1#2{%
    \ifnum#2=0%
        Load%
    \else%
        \ifnum#1=17 Run A\fi%
        \ifnum#1=18 Run B\fi%
        \ifnum#1=19 Run C\fi%
        \ifnum#1=20 Run A$^-$\fi%
        \ifnum#1=21 Run B$^-$\fi%
        \ifnum#1=22 Run C$^-$\fi%
    \fi%
}

% Function to generate a subfigure with specified parameters
% #1 = case_id (17, 18, 19, 20, 21, 22)
% #2 = caption (Load, Run A, Run B, etc.)
% #3 = throughput type (fill_throughput or run_throughput)
% #4 = entry_id (0 or 1)
\newcommand{\generateSubfigure}[4]{%
\begin{subfigure}[b]{0.24\textwidth}
\centering
\begin{tikzpicture}
\begin{axis}[
    width=3.8cm,
    height=3.8cm,
    ylabel={Throughput (M/s)},
    ybar,
    bar width=5pt,
    xticklabels={},
    xtick style={draw=none},
    axis lines=box,
    tick align=inside,
    scaled ticks=true,
    tick label style={/pgf/number format/fixed,/pgf/number format/precision=1},
    ymajorgrids=true,
    yminorgrids=true,
    minor tick num=1,
    max space between ticks=35pt,
    try min ticks=5,
    grid style={gray!30},
    ymin=0
]
\addAllStandardPlots{#1}{#3}{#4}
\end{axis}
\end{tikzpicture}
\caption{#2}
\end{subfigure}%
}

% Special command for the first subfigure that creates the legend
% #4 = entry_id (0 or 1)
\newcommand{\generateFirstSubfigure}[4]{%
\begin{subfigure}[b]{0.24\textwidth}
\centering
\begin{tikzpicture}
\begin{axis}[
    width=3.8cm,
    height=3.8cm,
    ylabel={Throughput (M/s)},
    ybar,
    bar width=5pt,
    xticklabels={},
    xtick style={draw=none},
    axis lines=box,
    tick align=inside,
    scaled ticks=true,
    tick label style={/pgf/number format/fixed,/pgf/number format/precision=1},
    ymajorgrids=true,
    yminorgrids=true,
    minor tick num=1,
    max space between ticks=35pt,
    try min ticks=5,
    grid style={gray!30},
    ymin=0,
    legend entries = {Cuckoo, Iceberg, Junction, TPHT, Blast},
    legend cell align = left,
    legend style={draw=none},
    legend to name={throughput-legend}
]
\addAllStandardPlots{#1}{#3}{#4}
\end{axis}
\end{tikzpicture}
\caption{#2}
\end{subfigure}%
}

% Special command for the first subfigure that creates the legend for resizing figure
% Uses resizable variants: object 18 instead of 17, object 21 instead of 20
\newcommand{\generateFirstSubfigureResizing}[4]{%
\begin{subfigure}[b]{0.24\textwidth}
\centering
\begin{tikzpicture}
\begin{axis}[
    width=3.8cm,
    height=3.8cm,
    ylabel={Throughput (M/s)},
    ybar,
    bar width=5pt,
    xticklabels={},
    xtick style={draw=none},
    axis lines=box,
    tick align=inside,
    scaled ticks=true,
    tick label style={/pgf/number format/fixed,/pgf/number format/precision=1},
    ymajorgrids=true,
    yminorgrids=true,
    minor tick num=1,
    max space between ticks=35pt,
    try min ticks=5,
    grid style={gray!30},
    ymin=0,
    legend entries = {Cuckoo, Iceberg, Junction, TPHT, Blast},
    legend cell align = left,
    legend style={draw=none},
    legend to name={throughput-legend-resizing}
]
\addAllResizingPlots{#1}{#3}{#4}
\end{axis}
\end{tikzpicture}
\caption{#2}
\end{subfigure}%
}

% Function to generate a subfigure for resizing variants
% Uses resizable variants: object 18 instead of 17, object 21 instead of 20
\newcommand{\generateSubfigureResizing}[4]{%
\begin{subfigure}[b]{0.24\textwidth}
\centering
\begin{tikzpicture}
\begin{axis}[
    width=3.8cm,
    height=3.8cm,
    ylabel={Throughput (M/s)},
    ybar,
    bar width=5pt,
    xticklabels={},
    xtick style={draw=none},
    axis lines=box,
    tick align=inside,
    scaled ticks=true,
    tick label style={/pgf/number format/fixed,/pgf/number format/precision=1},
    ymajorgrids=true,
    yminorgrids=true,
    minor tick num=1,
    max space between ticks=35pt,
    try min ticks=5,
    grid style={gray!30},
    ymin=0
]
\addAllResizingPlots{#1}{#3}{#4}
\end{axis}
\end{tikzpicture}
\caption{#2}
\end{subfigure}%
}

\begin{document}

\title{YCSB Throughput Results}
\author{}
\date{}
\maketitle

% Read the CSV data
\pgfplotstableread[col sep=comma]{../results/csv/ycsb_results.csv}{\data}

% Dictionary reference table
\section{Dictionary Mapping}
\begin{table}[h!]
\centering
\begin{tabular}{|c|c|c|}
\hline
Case ID & Entry ID & Label \\
\hline
17-22 & 0 & Load \\
\hline
17 & 1 & Run A \\
18 & 1 & Run B \\
19 & 1 & Run C \\
20 & 1 & Run A$^-$ \\
21 & 1 & Run B$^-$ \\
22 & 1 & Run C$^-$ \\
\hline
\end{tabular}
\caption{Case ID and Entry ID to Label Mapping}
\label{tab:dictionary}
\end{table}

\section{Throughput Results by Workload Type}

\begin{figure}[p]
\centering

% Row 1: Legend, Run A, Run B, Run C
\begin{subfigure}[b]{0.24\textwidth}
\centering
\pgfplotslegendfromname{throughput-legend}
\vspace{0.75cm}
\end{subfigure}
\generateFirstSubfigure{17}{Run A}{run_throughput}{0}
\generateSubfigure{18}{Run B}{run_throughput}{0}
\generateSubfigure{19}{Run C}{run_throughput}{0}

% Row 2: Load, Run A^-, Run B^-, Run C^-
\generateSubfigure{17}{Load}{fill_throughput}{0}
\generateSubfigure{20}{Run A$^-$}{run_throughput}{0}
\generateSubfigure{21}{Run B$^-$}{run_throughput}{0}
\generateSubfigure{22}{Run C$^-$}{run_throughput}{0}

\caption{YCSB Throughput Results by Workload Type. Load shows fill throughput from case 17. Run workloads show run throughput from their respective cases (17-22). All data uses entry\_id=0 (resizing disabled).}
\label{fig:throughput_subfigures}
\end{figure}

\begin{figure}[p]
\centering

% Row 1: Legend, Run A, Run B, Run C
\begin{subfigure}[b]{0.24\textwidth}
\centering
\pgfplotslegendfromname{throughput-legend}
\vspace{0.75cm}
\end{subfigure}
\generateFirstSubfigureResizing{17}{Run A}{run_throughput}{1}
\generateSubfigureResizing{18}{Run B}{run_throughput}{1}
\generateSubfigureResizing{19}{Run C}{run_throughput}{1}

% Row 2: Load, Run A^-, Run B^-, Run C^-
\generateSubfigureResizing{17}{Load}{fill_throughput}{1}
\generateSubfigureResizing{20}{Run A$^-$}{run_throughput}{1}
\generateSubfigureResizing{21}{Run B$^-$}{run_throughput}{1}
\generateSubfigureResizing{22}{Run C$^-$}{run_throughput}{1}

\caption{YCSB Throughput Results by Workload Type with Resizing Enabled. Load shows fill throughput from case 17. Run workloads show run throughput from their respective cases (17-22). All data uses entry\_id=1 (resizing enabled).}
\label{fig:throughput_subfigures_resizing}
\end{figure}

\end{document}
